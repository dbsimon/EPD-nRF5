<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>E-INK DISPLAY</title>
	<link rel="shortcut icon" type="image/png" href="favicon.png">
	<link rel="stylesheet" href="css/main.css?v=20251109">
</head>

<body>
	<div class="main">
		<h3>E-INK DISPLAY</h3>
		<fieldset>
			<legend>BT Connection</legend>
			<div class="flex-container">
				<div class="flex-group">
					<button id="connectbutton" type="button" class="primary" onclick="preConnect()">CONNECT</button>
					<button id="reconnectbutton" type="button" class="secondary" onclick="reConnect()">RE-CONNECT</button>
					<button type="button" class="secondary" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
				</div>
				<div class="flex-group right debug">
					<label for="epddriver">é©±åŠ¨</label>
					<select id="epddriver" onchange="updateDitcherOptions()">
						<option value="01" data-color="blackWhiteColor" data-size="4.2_400_300">4.2å¯¸ (é»‘ç™½, UC8176)</option>
						<option value="03" data-color="threeColor" data-size="4.2_400_300">4.2å¯¸ (ä¸‰è‰², UC8176)</option>
						<option value="04" data-color="blackWhiteColor" data-size="4.2_400_300">4.2å¯¸ (é»‘ç™½, SSD1619)</option>
						<option value="02" data-color="threeColor" data-size="4.2_400_300">4.2å¯¸ (ä¸‰è‰², SSD1619)</option>
						<option value="05" data-color="fourColor" data-size="4.2_400_300">4.2å¯¸ (å››è‰², JD79668)</option>
						<option value="0d" data-color="fourColor" data-size="5.83_648_480">5.83å¯¸ (å››è‰², JD79665)</option>
						<option value="06" data-color="blackWhiteColor" data-size="7.5_800_480">7.5å¯¸ (é»‘ç™½, UC8179)</option>
						<option value="07" data-color="threeColor" data-size="7.5_800_480">7.5å¯¸ (ä¸‰è‰², UC8179)</option>
						<option value="0c" data-color="fourColor" data-size="7.5_800_480">7.5å¯¸ (å››è‰², JD79665)</option>
						<option value="08" data-color="blackWhiteColor" data-size="7.5_640_384">7.5å¯¸ä½åˆ† (é»‘ç™½, UC8159)</option>
						<option value="09" data-color="threeColor" data-size="7.5_640_384">7.5å¯¸ä½åˆ† (ä¸‰è‰², UC8159)</option>
						<option value="0a" data-color="blackWhiteColor" data-size="7.5_880_528">7.5å¯¸HD (é»‘ç™½, SSD1677)</option>
						<option value="0b" data-color="threeColor" data-size="7.5_880_528">7.5å¯¸HD (ä¸‰è‰², SSD1677)</option>
					</select>
				</div>
				<div class="flex-group debug">
					<label for="epdpins">å¼•è„š</label>
					<input id="epdpins" type="text" value="">
					<button id="setDriverbutton" type="button" class="primary" onclick="setDriver()">ç¡®å®š</button>
				</div>
			</div>
			<div class="log-container" id="log"></div>
		</fieldset>
		<fieldset>
			<legend>Mode</legend>
			<div class="flex-container">
				<div class="flex-group">
					<button id="calendarmodebutton" type="button" class="primary" onclick="syncTime(1)">æ—¥å†æ¨¡å¼</button>
					<button id="clockmodebutton" type="button" class="primary" onclick="syncTime(2)">æ—¶é’Ÿæ¨¡å¼</button>
					<button type="button" class="btn btn-info" onclick="setWeatherMode()">é¦™æ¸¯å¤©æ°£</button>
					<button id="clearscreenbutton" type="button" class="secondary" onclick="clearScreen()">æ¸…é™¤å±å¹•</button>
				</div>
				<div class="flex-group right debug">
					<input type="text" id="cmdTXT" value="">
					<button id="sendcmdbutton" type="button" class="primary" onclick="sendcmd()">å‘é€å‘½ä»¤</button>
				</div>
			</div>
		</fieldset>
		<fieldset>
			<legend>Picture Transfer</legend>
			<div class="flex-container">
				<input type="file" id="imageFile" accept=".png,.jpg,.bmp,.webp,.jpeg" onchange="updateImage()">
			</div>
			<div class="flex-container options">
				<div class="flex-group debug">
					<label for="canvasSize">ç”»å¸ƒå°ºå¯¸:</label>
					<select id="canvasSize" onchange="updateCanvasSize()">
						<option value="1.54_152_152">1.54 (152x152)</option>
						<option value="1.54_200_200">1.54 (200x200)</option>
						<option value="2.13_212_104">2.13 (212x104)</option>
						<option value="2.13_250_122">2.13 (250x122)</option>
						<option value="2.66_296_152">2.66 (296x152)</option>
						<option value="2.9_296_128">2.9 (296x128)</option>
						<option value="2.9_384_168">2.9 (384x168)</option>
						<option value="3.5_384_184">3.5 (384x184)</option>
						<option value="3.7_416_240">3.7 (416x240)</option>
						<option value="3.97_800_480">3.97 (800x480)</option>
						<option value="4.2_400_300" selected>4.2 (400x300)</option>
						<option value="5.79_792_272">5.79 (792x272)</option>
						<option value="5.83_600_448">5.83 (600x448)</option>
						<option value="5.83_648_480">5.83 (648x480)</option>
						<option value="7.5_640_384">7.5 (640x384)</option>
						<option value="7.5_800_480">7.5 (800x480)</option>
						<option value="7.5_880_528">7.5 (880x528)</option>
						<option value="10.2_960_640">10.2 (960x640)</option>
						<option value="10.85_1360_480">10.85 (1360x480)</option>
						<option value="11.6_960_640">11.6 (960x640)</option>
						<option value="4E_600_400">4E (600x400)</option>
						<option value="7.3E6">7.3E6 (480x800)</option>
					</select>
				</div>
				<div class="flex-group debug">
					<label for="ditherMode">é¢œè‰²æ¨¡å¼:</label>
					<select id="ditherMode" onchange="applyDither()">
						<option value="blackWhiteColor">åŒè‰²(é»‘ç™½)</option>
						<option value="threeColor">ä¸‰è‰²(é»‘ç™½çº¢)</option>
						<option value="fourColor">å››è‰²(é»‘ç™½çº¢é»„)</option>
						<option value="sixColor">å…­è‰²(é»‘ç™½çº¢é»„è“ç»¿)</option>
					</select>
				</div>
				<div class="flex-group">
					<label for="ditherAlg">æŠ–åŠ¨ç®—æ³•:</label>
					<select id="ditherAlg" onchange="applyDither()">
						<option value="floydSteinberg">Floyd-Steinberg</option>
						<option value="atkinson">Atkinson</option>
						<option value="bayer">Bayer</option>
						<option value="stucki">Stucki</option>
						<option value="jarvis">Jarvis-Judice-Ninke</option>
						<option value="none">æ— æŠ–åŠ¨</option>
					</select>
				</div>
				<div class="flex-group">
					<label for="ditherStrength">æŠ–åŠ¨å¼ºåº¦:</label>
					<input type="range" min="0" max="5" step="0.1" value="1.0" id="ditherStrength">
					<label id="ditherStrengthValue">1.0</label>
				</div>
				<div class="flex-group">
					<label for="ditherContrast">å¯¹æ¯”åº¦:</label>
					<input type="range" min="0.5" max="2" step="0.1" value="1.2" id="ditherContrast">
					<label id="ditherContrastValue">1.2</label>
				</div>
			</div>
			<div class="flex-container options">
				<div class="flex-group debug">
					<label for="mtusize">MTU:</label>
					<input type="number" id="mtusize" value="20" min="0" max="255">
					<label for="interleavedcount">ç¡®è®¤é—´éš”:</label>
					<input type="number" id="interleavedcount" value="50" min="0" max="500">
				</div>
			</div>
			<div class="status-bar"><b>çŠ¶æ€ï¼š</b><span id="status"></span></div>
			<div class="flex-container">
				<div class="flex-group">
					<button type="button" class="secondary debug" onclick="rotateCanvas()">Rotate</button>
					<button type="button" class="secondary" onclick="clearCanvas()">Clear</button>
					<button type="button" class="secondary debug" onclick="downloadDataArray()">Download Data Array</button>
					<button id="sendimgbutton" type="button" class="primary" onclick="sendimg()">Send Picture</button>
				</div>
			</div>
			<div class="canvas-container">
				<div class="canvas-title"></div>
				<canvas id="canvas" width="400" height="300"></canvas>
				<div class="flex-container canvas-tools">
					<div class="flex-group tool-buttons">
						<button id="brush-mode" title="ç”»ç¬”" class="tool-button">âœï¸</button>
						<button id="eraser-mode" title="æ©¡çš®æ“¦" class="tool-button">ğŸ§½</button>
						<button id="text-mode" title="Add Text" class="tool-button">T</button>
						<button id="undo-btn" title="Undo (Ctrl+Z)" class="tool-button hide">â†¶</button>
						<button id="redo-btn" title="Redo (Ctrl+Y)" class="tool-button hide">â†·</button>
					</div>
				</div>
				<div class="flex-container canvas-tools">
					<div class="flex-group brush-tools">
						<label for="brush-color">é¢œè‰²:</label>
						<select id="brush-color">
							<option value="#000000">é»‘è‰²</option>
							<option value="#FF0000">çº¢è‰²</option>
							<option value="#FFFF00">é»„è‰²</option>
							<option value="#00FF00">ç»¿è‰²</option>
							<option value="#0000FF">è“è‰²</option>
							<option value="#FFFFFF">ç™½è‰²</option>
						</select>
						<label for="brush-size">ç²—ç»†:</label>
						<input type="number" id="brush-size" value="20" min="1" max="100">
					</div>
				</div>
				<div class="flex-container canvas-tools">
					<div class="flex-group text-tools">
						<label for="font-family">å­—ä½“:</label>
						<select id="font-family">
							<option value="Arial">Arial</option>
							<option value="sans-serif">Sans-serif</option>
							<option value="monospace">Monospace</option>
							<option value="SimSun">å®‹ä½“</option>
							<option value="SimHei">é»‘ä½“</option>
							<option value="Microsoft Yahei">å¾®è½¯é›…é»‘</option>
							<option value="Microsoft JhengHei">å¾®è½¯æ­£é»‘ä½“</option>
							<option value="KaiTi">æ¥·ä½“</option>
							<option value="NSimSun">æ–°å®‹ä½“</option>
							<option value="FangSong">ä»¿å®‹</option>
							<option value="YouYuan">å¹¼åœ†</option>
							<option value="LiSu">éš¶ä¹¦</option>
							<option value="STHeiti">åæ–‡é»‘ä½“</option>
							<option value="STXihei">åæ–‡ç»†é»‘</option>
							<option value="STKaiti">åæ–‡æ¥·ä½“</option>
							<option value="STSong">åæ–‡å®‹ä½“</option>
							<option value="STFangsong">åæ–‡ä»¿å®‹</option>
							<option value="STZhongsong">åæ–‡ä¸­å®‹</option>
							<option value="STHupo">åæ–‡ç¥ç€</option>
							<option value="STXinwei">åæ–‡æ–°é­</option>
							<option value="STLiti">åæ–‡éš¶ä¹¦</option>
							<option value="STXingkai">åæ–‡è¡Œæ¥·</option>
							<option value="FZShuTi">æ–¹æ­£èˆ’ä½“</option>
							<option value="FZYaoti">æ–¹æ­£å§šä½“</option>
							<option value="PingFang SC">è‹¹æ–¹</option>
							<option value="Source Han Sans CN">æ€æºé»‘ä½“</option>
							<option value="Source Han Serif SC">æ€æºå®‹ä½“</option>
							<option value="WenQuanYi Micro Hei">æ–‡æ³‰é©¿å¾®ç±³é»‘</option>
							</optgroup>
						</select>
						<label for="font-size">å¤§å°:</label>
						<input type="number" id="font-size" value="50" min="1" max="100">
					</div>
					<div class="flex-group text-tools">
						<input type="text" id="text-input" placeholder="è¾“å…¥æ–‡å­—" style="width:150px">
						<button id="text-bold" title="ç²—ä½“">B</button>
						<button id="text-italic" title="æ–œä½“">I</button>
						<button id="add-text-btn" class="primary">æ·»åŠ æ–‡å­—</button>
					</div>
					<div class="flex-group crop-tools">
						<button id="crop-zoom-in" title="æ”¾å¤§" class="secondary">+</button>
						<button id="crop-zoom-out" title="ç¼©å°" class="secondary">-</button>
						<button id="crop-move-left" title="å·¦ç§»">â‡¦</button>
						<button id="crop-move-up" title="ä¸Šç§»">â‡§</button>
						<button id="crop-move-down" title="ä¸‹ç§»">â‡©</button>
						<button id="crop-move-right" title="å³ç§»">â‡¨</button>
						<button class="primary" onclick="applyDither()">å®Œæˆ</button>
					</div>
				</div>
			</div>
		</fieldset>
		<div class="footer">
			<span class="copy">&copy; 2025 tsl0922.</span>
			<span class="links">
				<a href="https://github.com/tsl0922/EPD-nRF5">Github</a>
				<a href="https://qm.qq.com/q/SckzhfDxuu" onclick="return confirm('æœ¬ç¾¤æ˜¯æ­¤å¼€æºå›ºä»¶ä½œè€…çš„æŠ€æœ¯äº¤æµç¾¤\nå¦‚æœä½ è´­ä¹°äº†æˆå“ï¼Œè¯·æ‰¾å–å®¶æä¾›å”®åï¼')">äº¤æµç¾¤</a>
				<a href="?debug=true" id="debug-toggle">å¼€å‘æ¨¡å¼</a>
			</span>
		</div>
	</div>
	<script type="text/javascript" src="js/dithering.js?v=20251109"></script>
	<script type="text/javascript" src="js/paint.js?v=20251109"></script>
	<script type="text/javascript" src="js/crop.js?v=20251109"></script>
	<script type="text/javascript" src="js/main.js?v=20251109"></script>
<!-- æ–°çš„å¤©æ°£åŠŸèƒ½ä»£ç¢¼ -->
	<script>
    // é¦™æ¸¯å¤©æ–‡å° API URL (ç¹é«”ä¸­æ–‡)
    const HKO_API_URL = 'https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=fnd&lang=tc';

    async function setWeatherMode() {
        // 1. é¡¯ç¤ºè¼‰å…¥ä¸­
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'black';
        ctx.font = '30px sans-serif'; 
        ctx.fillText("è®€å–å¤©æ–‡å°æ•¸æ“š...", 10, 50);
        
        // å‘¼å«åŸæœ‰çš„ render å‡½æ•¸ä¾†æ›´æ–°é è¦½
        if (typeof render === 'function') render(); 

        try {
            // 2. æŠ“å– API æ•¸æ“š
            const response = await fetch(HKO_API_URL);
            const data = await response.json();
            
            // 3. è§£ææ•¸æ“š (ä»Šå¤©å’Œæ˜å¤©)
            const today = data.weatherForecast[0];
            const tomorrow = data.weatherForecast[1];

            const todayTemp = `${today.forecastMintemp.value}Â°C - ${today.forecastMaxtemp.value}Â°C`;
            const tomorrowTemp = `${tomorrow.forecastMintemp.value}Â°C - ${tomorrow.forecastMaxtemp.value}Â°C`;
            const updateTime = new Date().toLocaleTimeString('zh-HK', {hour: '2-digit', minute:'2-digit'});

            // 4. æ¸…ç©ºç•«å¸ƒä¸¦ç¹ªè£½
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'black';
            
            // é€™è£¡çš„æ’ç‰ˆåº§æ¨™ (x, y)
            ctx.font = 'bold 36px sans-serif';
            ctx.fillText("é¦™æ¸¯å¤©æ°£é å ±", 20, 50);
            
            ctx.font = '24px sans-serif';
            ctx.fillText(`ä»Šå¤© (${today.week.replace('æ˜ŸæœŸ', '')}):`, 20, 100);
            ctx.font = 'bold 50px Arial';
            ctx.fillText(todayTemp, 20, 155);
            
            ctx.font = '24px sans-serif';
            ctx.fillText(`æ˜å¤© (${tomorrow.week.replace('æ˜ŸæœŸ', '')}):`, 20, 210);
            ctx.font = 'bold 40px Arial';
            ctx.fillText(tomorrowTemp, 20, 255);
            
            ctx.font = '16px sans-serif';
            ctx.fillText(`æ›´æ–°æ–¼: ${updateTime}`, 20, 290);

            // 5. æ¸²æŸ“é è¦½
            if (typeof render === 'function') render(); 
            
            // è‡ªå‹•å‚³è¼¸åˆ°è¨­å‚™ (å¦‚æœæƒ³è¦è‡ªå‹•æ›´æ–°ï¼Œå–æ¶ˆä¸‹é¢é€™è¡Œçš„è¨»è§£)
            // if (typeof process === 'function') process();

        } catch (error) {
            console.error(error);
            ctx.fillStyle = 'black';
            ctx.font = '24px sans-serif';
            ctx.fillText("å¤©æ°£æ•¸æ“šç²å–å¤±æ•—", 10, 50);
            if (typeof render === 'function') render();
        }
    }
    </script>
	
</body>

</html>
